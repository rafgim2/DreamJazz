<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Teclado Diatónico MIDI</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    label, select, button {
      margin: 5px 0;
      display: block;
    }
    #status {
      margin-top: 10px;
      color: green;
    }
  </style>
</head>
<body>
  <h2>Teclado Diatónico MIDI (solo teclas blancas)</h2>

  <!-- Select para elegir entrada y salida MIDI -->
  <label for="midi-in">Dispositivo MIDI de entrada:</label>
  <select id="midi-in"></select>

  <label for="midi-out">Dispositivo MIDI de salida:</label>
  <select id="midi-out"></select>

  <!-- Selección del acorde: raíz y tipo -->
  <label for="root-select">Raíz del acorde:</label>
  <select id="root-select">
    <option value="0">C</option>
    <option value="1">C♯/D♭</option>
    <option value="2">D</option>
    <option value="3">D♯/E♭</option>
    <option value="4">E</option>
    <option value="5">F</option>
    <option value="6">F♯/G♭</option>
    <option value="7">G</option>
    <option value="8">G♯/A♭</option>
    <option value="9">A</option>
    <option value="10">A♯/B♭</option>
    <option value="11">B</option>
  </select>

  <label for="type-select">Tipo de acorde:</label>
  <select id="type-select">
    <!-- Por simplicidad, incluyo los tipos más comunes y sus modos asociados -->
    <option value="ionian">Mayor (Ionian, maj)</option>
    <option value="dorian">Menor (Dorian, m7)</option>
    <option value="mixolydian">Dominante 7 (Mixolydian)</option>
    <option value="lydian">Mayor #11 (Lydian)</option>
    <option value="locrian">Semidisminuido (m7♭5, Locrian)</option>
    <option value="phrygian">Phrygian (uso ocasional)</option>
    <option value="aeolian">Menor natural (Aeolian)</option>
    <!-- Puedes agregar más modos/escala alterada si quieres -->
  </select>

  <!-- Botón para aplicar/desactivar re-mapeo -->
  <button id="enable-button">Habilitar re-mapeo</button>
  <button id="disable-button" disabled>Desactivar re-mapeo</button>

  <div id="status">Estado: esperando conexión MIDI…</div>

  <script>
    // ------------------------------------------
    // 1. Datos básicos: semitonos blancos y modos
    // ------------------------------------------

    // Semitonos de las teclas blancas dentro de una octava (C=0, C#=1, D=2, ... B=11)
    const WHITE_SEMITONES = [0, 2, 4, 5, 7, 9, 11];

    // Intervalos (en semitonos) de cada modo, partiendo de la tónica (0):
    const SCALE_INTERVALS = {
      ionian:      [0, 2, 4, 5, 7, 9, 11],   // Mayor (Escala jónica)
      dorian:      [0, 2, 3, 5, 7, 9, 10],   // Dórico
      mixolydian:  [0, 2, 4, 5, 7, 9, 10],   // Mixolidio
      lydian:      [0, 2, 4, 6, 7, 9, 11],   // Lidio
      locrian:     [0, 1, 3, 5, 6, 8, 10],   // Locrio
      phrygian:    [0, 1, 3, 5, 7, 8, 10],   // Frigio
      aeolian:     [0, 2, 3, 5, 7, 8, 10]    // Eolio (menor natural)
      // Si quisieras una escala alterada podrías añadirla aquí
    };

    // ------------------------------------------
    // 2. Variables de estado y referencias DOM
    // ------------------------------------------
    let midiAccess = null;
    let chosenInput = null;
    let chosenOutput = null;
    let isRemapOn = false;

    const selInput  = document.getElementById('midi-in');
    const selOutput = document.getElementById('midi-out');
    const selRoot   = document.getElementById('root-select');
    const selType   = document.getElementById('type-select');
    const btnEnable = document.getElementById('enable-button');
    const btnDisable= document.getElementById('disable-button');
    const statusEl  = document.getElementById('status');

    // Mapa para recordar qué nota original disparó qué nota re-mapeada
    // clave = noteNumber original; valor = noteNumber re-mapeada
    const activeNotesMap = new Map();

    // ------------------------------------------
    // 3. Función para iniciar Web MIDI
    // ------------------------------------------
    function onMIDISuccess(access) {
      midiAccess = access;
      statusEl.textContent = 'Estado: Web MIDI inicializado.';

      // Llenar los <select> con dispositivos disponibles
      updateDeviceLists();

      // Escuchar cambios en la lista de dispositivos (plug & unplug)
      midiAccess.onstatechange = updateDeviceLists;
    }

    function onMIDIFailure(err) {
      statusEl.textContent = 'ERROR: No se pudo acceder a Web MIDI — ' + err;
      statusEl.style.color = 'red';
    }

    function updateDeviceLists() {
      // Vaciar selects
      selInput.innerHTML  = '';
      selOutput.innerHTML = '';

      // Agregar cada entrada
      midiAccess.inputs.forEach((port) => {
        const opt = document.createElement('option');
        opt.value = port.id;
        opt.textContent = port.name + ' [' + port.manufacturer + ']';
        selInput.appendChild(opt);
      });

      // Agregar cada salida
      midiAccess.outputs.forEach((port) => {
        const opt = document.createElement('option');
        opt.value = port.id;
        opt.textContent = port.name + ' [' + port.manufacturer + ']';
        selOutput.appendChild(opt);
      });

      // Si no hay nada, dejar mensaje
      if (selInput.children.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '— Sin entrada MIDI disponible —';
        opt.disabled = true;
        selInput.appendChild(opt);
      }
      if (selOutput.children.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '— Sin salida MIDI disponible —';
        opt.disabled = true;
        selOutput.appendChild(opt);
      }
    }

    // ------------------------------------------
    // 4. Detectar selección de puerto MIDI
    // ------------------------------------------
    selInput.addEventListener('change', () => {
      // Cambiamos la entrada seleccionada
      const id = selInput.value;
      if (chosenInput) {
        chosenInput.onmidimessage = null;
      }
      chosenInput = midiAccess.inputs.get(id) || null;

      // Si el re-mapeo ya estaba activo, volvemos a conectar
      if (isRemapOn && chosenInput) {
        chosenInput.onmidimessage = handleMIDIMessage;
      }
    });

    selOutput.addEventListener('change', () => {
      const id = selOutput.value;
      chosenOutput = midiAccess.outputs.get(id) || null;
    });

    // ------------------------------------------
    // 5. Botones para habilitar/deshabilitar
    // ------------------------------------------
    btnEnable.addEventListener('click', () => {
      if (!chosenInput || !chosenOutput) {
        alert('Por favor, selecciona simultáneamente una entrada y una salida MIDI.');
        return;
      }
      // Desactivar Local Control del teclado (CC 122 = Local Control On/Off, 0 = Off)
      // Esto hace que el teclado no suene internamente, solo envíe MIDI externo.
      // Su canal por defecto es el 1 (0) a menos que tu dispositivo use otro canal.
      chosenOutput.send([0xB0, 122, 0]);

      // Limpiar mapa de notas activas
      activeNotesMap.clear();
      // Conectar listener
      chosenInput.onmidimessage = handleMIDIMessage;
      isRemapOn = true;
      btnEnable.disabled  = true;
      btnDisable.disabled = false;
      statusEl.textContent = 'Estado: Re-mapeo activo. Toca las teclas blancas.';
    });

    btnDisable.addEventListener('click', () => {
      if (chosenInput) chosenInput.onmidimessage = null;
      // Volver a activar Local Control (CC 122 = 127 → On)
      if (chosenOutput) chosenOutput.send([0xB0, 122, 127]);

      // Apagar cualquier nota pendiente
      activeNotesMap.forEach((mappedNote, orig) => {
        // Enviar note off para cada nota re-mapeada que quede en activo
        chosenOutput.send([0x80 | 0, mappedNote, 0]);
      });
      activeNotesMap.clear();

      isRemapOn = false;
      btnEnable.disabled  = false;
      btnDisable.disabled = true;
      statusEl.textContent = 'Estado: Re-mapeo desactivado.';
    });

    // ------------------------------------------
    // 6. Cálculo de la escala según acorde elegido
    // ------------------------------------------
    function getScaleForChord() {
      const rootPc = parseInt(selRoot.value);       // 0 = C, 1 = C#, etc.
      const mode   = selType.value;                 // ‘ionian’, ‘dorian’, etc.
      const intervals = SCALE_INTERVALS[mode];      // [0,2,4,5,7,9,11], etc.

      // Generamos un array con los 7 “pitch classes” absolutas de la escala:
      // scalePcs[i] = (rootPc + intervals[i]) % 12
      const scalePcs = intervals.map(i => (rootPc + i) % 12);
      return scalePcs;  // e.g. para G mixolydian, [7,9,11,0,2,4,5]
    }

    // ------------------------------------------
    // 7. Función de re-mapeo: tecla blanca → nota de escala
    // ------------------------------------------
    function mapToScale(originalNoteNumber) {
      // originalNoteNumber es 0..127
      const pc = originalNoteNumber % 12;         // pitch class de la tecla presionada
      const octave = Math.floor(originalNoteNumber / 12);
      const scalePcs = getScaleForChord();

      // 1) Determinar si ‘pc’ corresponde a una tecla blanca (C, D, E, F, G, A, B)
      const whiteIdx = WHITE_SEMITONES.indexOf(pc);
      if (whiteIdx === -1) {
        // No es blanca → devolvemos null para “ignorar”
        return null;
      }

      // 2) Tomamos el pitch class de la escala en esa posición (whiteIdx)
      const targetPc = scalePcs[whiteIdx];  // valor entre 0 y 11

      // 3) Construir el número MIDI en la misma octava que la original:
      //    notaRemap = targetPc + (octave * 12).
      //    Si targetPc > pc, a veces quizá suene un semitono más alto en la misma octava.
      //    Para simplificar, aquí forzamos queda en la MISMA octava que la original:  
      const mappedNote = targetPc + octave * 12;

      // IMPORTANTE: si targetPc + (octave*12) cae fuera de [0..127], habría que ajustarlo.
      if (mappedNote < 0 || mappedNote > 127) return null;
      return mappedNote;
    }

    // ------------------------------------------
    // 8. Handler de mensajes MIDI entrantes
    // ------------------------------------------
    function handleMIDIMessage(event) {
      const [status, data1, data2] = event.data;
      const command = status & 0xF0;
      const channel = status & 0x0F;

      // Solo re-mapear note on (0x90) y note off (0x80) del canal 0 (0 = canal 1), 
      // aunque podrías adaptarlo para otros canales.
      if (command === 0x90 && data2 > 0) {
        // Note On
        const origNote = data1;
        const velocity = data2;
        const remapped = mapToScale(origNote);

        if (remapped !== null) {
          // Guardamos que origNote → remapped
          activeNotesMap.set(origNote, remapped);
          // Enviamos Note On al dispositivo de salida
          chosenOutput.send([0x90 | channel, remapped, velocity]);
        }
        // Si remapped === null (tecla negra), no hacemos nada (ignorar).
      }
      else if ((command === 0x80) || (command === 0x90 && data2 === 0)) {
        // Note Off (o Note On con vel=0)
        const origNote = data1;
        // Buscamos si teníamos almacenada una nota re-mapeada
        if (activeNotesMap.has(origNote)) {
          const remapped = activeNotesMap.get(origNote);
          chosenOutput.send([0x80 | channel, remapped, 0]);
          activeNotesMap.delete(origNote);
        }
        // Si no existía en el Map (porque era negra o no estaba mapeada), nada que hacer.
      }
      // Podrías añadir aquí más lógica (p. ej. pasar a través mensajes de CC),
      // pero la idea principal es re-mapear nota blanca → nota de escala.
    }

    // ------------------------------------------
    // 9. Inicializar todo
    // ------------------------------------------
    if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess({ sysex: false })
        .then(onMIDISuccess, onMIDIFailure);
    } else {
      statusEl.textContent = 'ERROR: Tu navegador no soporta Web MIDI.';
      statusEl.style.color = 'red';
    }
  </script>
</body>
</html>
