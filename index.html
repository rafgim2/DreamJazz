<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Teclado Diatónico MIDI</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    label, select, button {
      margin: 5px 0;
      display: block;
    }
    #status {
      margin-top: 10px;
      color: green;
    }
  </style>
</head>
<body>
  <h2>Teclado Diatónico MIDI (solo teclas blancas)</h2>

  <!-- Select para elegir entrada y salida MIDI -->
  <label for="midi-in">Dispositivo MIDI de entrada:</label>
  <select id="midi-in"></select>

  <label for="midi-out">Dispositivo MIDI de salida:</label>
  <select id="midi-out"></select>

  <!-- Selección del acorde: raíz y tipo -->
  <label for="root-select">Raíz del acorde:</label>
  <select id="root-select">
    <option value="0">C</option>
    <option value="1">C♯/D♭</option>
    <option value="2">D</option>
    <option value="3">D♯/E♭</option>
    <option value="4">E</option>
    <option value="5">F</option>
    <option value="6">F♯/G♭</option>
    <option value="7">G</option>
    <option value="8">G♯/A♭</option>
    <option value="9">A</option>
    <option value="10">A♯/B♭</option>
    <option value="11">B</option>
  </select>

  <label for="type-select">Tipo de acorde:</label>
  <select id="type-select">
    <option value="ionian">Mayor (Ionian, maj)</option>
    <option value="dorian">Menor (Dorian, m7)</option>
    <option value="mixolydian">Dominante 7 (Mixolydian)</option>
    <option value="lydian">Mayor #11 (Lydian)</option>
    <option value="locrian">Semidisminuido (m7♭5, Locrian)</option>
    <option value="phrygian">Phrygian (uso ocasional)</option>
    <option value="aeolian">Menor natural (Aeolian)</option>
  </select>

  <!-- Botón para aplicar/desactivar re-mapeo -->
  <button id="enable-button">Habilitar re-mapeo</button>
  <button id="disable-button" disabled>Desactivar re-mapeo</button>

  <div id="status">Estado: esperando conexión MIDI…</div>

  <script>
    // ------------------------------------------
    // 1. Datos básicos: semitonos blancos y modos
    // ------------------------------------------
    const WHITE_SEMITONES = [0, 2, 4, 5, 7, 9, 11];
    const SCALE_INTERVALS = {
      ionian:      [0, 2, 4, 5, 7, 9, 11],
      dorian:      [0, 2, 3, 5, 7, 9, 10],
      mixolydian:  [0, 2, 4, 5, 7, 9, 10],
      lydian:      [0, 2, 4, 6, 7, 9, 11],
      locrian:     [0, 1, 3, 5, 6, 8, 10],
      phrygian:    [0, 1, 3, 5, 7, 8, 10],
      aeolian:     [0, 2, 3, 5, 7, 8, 10]
    };

    // ------------------------------------------
    // 2. Variables de estado y referencias DOM
    // ------------------------------------------
    let midiAccess = null;
    let chosenInput = null;
    let chosenOutput = null;
    let isRemapOn = false;

    const selInput   = document.getElementById('midi-in');
    const selOutput  = document.getElementById('midi-out');
    const selRoot    = document.getElementById('root-select');
    const selType    = document.getElementById('type-select');
    const btnEnable  = document.getElementById('enable-button');
    const btnDisable = document.getElementById('disable-button');
    const statusEl   = document.getElementById('status');

    const activeNotesMap = new Map();

    // ------------------------------------------
    // 3. Cargar Web MIDI y poblar listas
    // ------------------------------------------
    function onMIDISuccess(access) {
      midiAccess = access;
      statusEl.textContent = 'Estado: Web MIDI inicializado.';

      updateDeviceLists();
      midiAccess.onstatechange = updateDeviceLists;
    }

    function onMIDIFailure(err) {
      statusEl.textContent = 'ERROR: No se pudo acceder a Web MIDI — ' + err;
      statusEl.style.color = 'red';
    }

    function updateDeviceLists() {
      selInput.innerHTML  = '';
      selOutput.innerHTML = '';

      midiAccess.inputs.forEach((port) => {
        const opt = document.createElement('option');
        opt.value = port.id;
        opt.textContent = port.name + ' [' + port.manufacturer + ']';
        selInput.appendChild(opt);
      });

      midiAccess.outputs.forEach((port) => {
        const opt = document.createElement('option');
        opt.value = port.id;
        opt.textContent = port.name + ' [' + port.manufacturer + ']';
        selOutput.appendChild(opt);
      });

      if (selInput.children.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '— Sin entrada MIDI disponible —';
        opt.disabled = true;
        selInput.appendChild(opt);
      }
      if (selOutput.children.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '— Sin salida MIDI disponible —';
        opt.disabled = true;
        selOutput.appendChild(opt);
      }

      // Si al actualizar hay al menos uno, lo asignamos como “elegido” por defecto:
      if (!chosenInput && midiAccess.inputs.size > 0) {
        const firstId = midiAccess.inputs.keys().next().value;
        selInput.value = firstId;
        chosenInput = midiAccess.inputs.get(firstId);
      }
      if (!chosenOutput && midiAccess.outputs.size > 0) {
        const firstId = midiAccess.outputs.keys().next().value;
        selOutput.value = firstId;
        chosenOutput = midiAccess.outputs.get(firstId);
      }
    }

    // ------------------------------------------
    // 4. Cuando el usuario cambia manualmente el select
    // ------------------------------------------
    selInput.addEventListener('change', () => {
      const id = selInput.value;
      chosenInput = midiAccess.inputs.get(id) || null;
      if (isRemapOn && chosenInput) {
        chosenInput.onmidimessage = handleMIDIMessage;
      }
    });

    selOutput.addEventListener('change', () => {
      const id = selOutput.value;
      chosenOutput = midiAccess.outputs.get(id) || null;
    });

    // ------------------------------------------
    // 5. Botones Habilitar/Deshabilitar re-mapeo
    // ------------------------------------------
    btnEnable.addEventListener('click', () => {
      // En lugar de fiarnos de chosenInput/Output tal como vinieran,
      // leemos siempre lo que haya seleccionado el usuario en ese momento:
      const inputId  = selInput.value;
      const outputId = selOutput.value;
      chosenInput  = midiAccess.inputs.get(inputId)  || null;
      chosenOutput = midiAccess.outputs.get(outputId) || null;

      if (!chosenInput || !chosenOutput) {
        alert('Por favor, selecciona simultáneamente una entrada y una salida MIDI.');
        return;
      }

      // Desactivamos local control (CC122 = 0)
      chosenOutput.send([0xB0, 122, 0]);

      activeNotesMap.clear();
      chosenInput.onmidimessage = handleMIDIMessage;
      isRemapOn = true;
      btnEnable.disabled  = true;
      btnDisable.disabled = false;
      statusEl.textContent = 'Estado: Re-mapeo activo. Toca las teclas blancas.';
    });

    btnDisable.addEventListener('click', () => {
      if (chosenInput) chosenInput.onmidimessage = null;
      if (chosenOutput) {
        // Reactivamos local control (CC122 = 127)
        chosenOutput.send([0xB0, 122, 127]);

        // Apagar notas que pudieran quedar colgadas
        activeNotesMap.forEach((mappedNote, orig) => {
          chosenOutput.send([0x80, mappedNote, 0]);
        });
        activeNotesMap.clear();
      }

      isRemapOn = false;
      btnEnable.disabled  = false;
      btnDisable.disabled = true;
      statusEl.textContent = 'Estado: Re-mapeo desactivado.';
    });

    // ------------------------------------------
    // 6. Cálculo de escala según acorde
    // ------------------------------------------
    function getScaleForChord() {
      const rootPc = parseInt(selRoot.value);
      const mode   = selType.value;
      const intervals = SCALE_INTERVALS[mode];
      return intervals.map(i => (rootPc + i) % 12);
    }

    // ------------------------------------------
    // 7. Mapeo nota entrante → nota de escala
    // ------------------------------------------
    function mapToScale(originalNoteNumber) {
      const pc     = originalNoteNumber % 12;
      const octave = Math.floor(originalNoteNumber / 12);
      const scalePcs = getScaleForChord();

      const whiteIdx = WHITE_SEMITONES.indexOf(pc);
      if (whiteIdx === -1) return null;

      const targetPc = scalePcs[whiteIdx];
      const mappedNote = targetPc + octave * 12;
      if (mappedNote < 0 || mappedNote > 127) return null;
      return mappedNote;
    }

    // ------------------------------------------
    // 8. Procesar mensajes MIDI entrantes
    // ------------------------------------------
    function handleMIDIMessage(event) {
      const [status, data1, data2] = event.data;
      const command = status & 0xF0;
      const channel = status & 0x0F;

      if (command === 0x90 && data2 > 0) { // Note On
        const origNote = data1;
        const velocity = data2;
        const remapped = mapToScale(origNote);
        if (remapped !== null) {
          activeNotesMap.set(origNote, remapped);
          chosenOutput.send([0x90 | channel, remapped, velocity]);
        }
      }
      else if ((command === 0x80) || (command === 0x90 && data2 === 0)) {
        const origNote = data1;
        if (activeNotesMap.has(origNote)) {
          const remapped = activeNotesMap.get(origNote);
          chosenOutput.send([0x80 | channel, remapped, 0]);
          activeNotesMap.delete(origNote);
        }
      }
    }

    // ------------------------------------------
    // 9. Inicializar Web MIDI
    // ------------------------------------------
    if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess({ sysex: false })
        .then(onMIDISuccess, onMIDIFailure);
    } else {
      statusEl.textContent = 'ERROR: Tu navegador no soporta Web MIDI.';
      statusEl.style.color = 'red';
    }
  </script>
</body>
</html>
